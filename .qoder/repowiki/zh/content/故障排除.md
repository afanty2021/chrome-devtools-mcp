# 故障排除

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [src/main.ts](file://src/main.ts)
- [src/browser.ts](file://src/browser.ts)
- [src/cli.ts](file://src/cli.ts)
- [src/logger.ts](file://src/logger.ts)
- [src/McpContext.ts](file://src/McpContext.ts)
- [src/McpResponse.ts](file://src/McpResponse.ts)
- [src/tools/ToolDefinition.ts](file://src/tools/ToolDefinition.ts)
- [package.json](file://package.json)
- [tests/browser.test.ts](file://tests/browser.test.ts)
</cite>

## 目录
1. [简介](#简介)
2. [连接问题](#连接问题)
3. [权限与沙盒问题](#权限与沙盒问题)
4. [性能瓶颈与超时](#性能瓶颈与超时)
5. [工具调用失败](#工具调用失败)
6. [环境相关问题](#环境相关问题)
7. [调试日志与诊断](#调试日志与诊断)

## 简介
本指南旨在系统性地解决使用 `chrome-devtools-mcp` 时可能遇到的常见问题。`chrome-devtools-mcp` 是一个 Model-Context-Protocol (MCP) 服务器，允许 AI 编码助手通过 Chrome DevTools 控制和检查实时 Chrome 浏览器。常见问题主要集中在连接、权限、性能和工具调用等方面。本指南将提供详细的诊断步骤和解决方案，帮助用户快速恢复服务。

**Section sources**
- [README.md](file://README.md#L1-L50)

## 连接问题
连接问题是使用 `chrome-devtools-mcp` 时最常见的障碍，主要表现为无法启动浏览器或无法建立 WebSocket 连接。

### 无法启动浏览器
当 `chrome-devtools-mcp` 无法启动 Chrome 浏览器时，通常会遇到以下错误：
- **错误信息**: `The browser is already running for <userDataDir>. Use --isolated to run multiple browser instances.`
- **原因分析**: 该错误表明 `chrome-devtools-mcp` 尝试使用的用户数据目录（user-data-dir）已被另一个正在运行的 Chrome 实例占用。默认情况下，`chrome-devtools-mcp` 使用一个持久化的用户数据目录（如 `$HOME/.cache/chrome-devtools-mcp/chrome-profile-stable`）来保持状态，但同一目录不能被多个浏览器实例同时使用。
- **解决方案**:
  1. **使用 `--isolated` 选项**: 这是最推荐的解决方案。通过在 MCP 客户端配置中添加 `--isolated=true`，`chrome-devtools-mcp` 将创建一个临时的用户数据目录，该目录在浏览器关闭后会自动清理，从而避免与现有实例冲突。
  2. **手动终止现有进程**: 使用操作系统的任务管理器或命令行工具（如 `ps` 和 `kill`）查找并终止所有与 Chrome 相关的进程。
  3. **指定自定义用户数据目录**: 使用 `--executablePath` 或通过 `--chromeArg` 传递 `--user-data-dir` 参数来指定一个不同的目录。
- **预防措施**: 在生产或自动化环境中，始终使用 `--isolated` 选项以确保实例的独立性和可预测性。

### WebSocket 连接失败 (wsEndpoint)
当使用 `--wsEndpoint` 或 `--browserUrl` 连接到已运行的 Chrome 实例时，可能会遇到连接失败。
- **错误信息**: `Either browserURL or wsEndpoint must be provided`, `Provided wsEndpoint is not valid URL.`
- **原因分析**:
  - **参数冲突**: 同时指定了 `--browserUrl` 和 `--wsEndpoint`，而这两个选项是互斥的。
  - **URL 格式错误**: `--wsEndpoint` 必须以 `ws://` 或 `wss://` 开头。
  - **Chrome 实例未启动**: 指定的调试端口上没有运行的 Chrome 实例。
  - **端口未正确启用**: Chrome 启动时未使用 `--remote-debugging-port` 参数。
- **解决方案**:
  1. **验证配置**: 确保 MCP 客户端配置中只使用 `--browserUrl` 或 `--wsEndpoint` 中的一个。
  2. **获取正确的 WebSocket 端点**: 启动 Chrome 后，访问 `http://127.0.0.1:9222/json/version`，从返回的 JSON 中提取 `webSocketDebuggerUrl` 字段的值。
  3. **正确启动 Chrome**: 使用 `--remote-debugging-port=9222` 和 `--user-data-dir` 参数启动 Chrome。例如：
     ```bash
     google-chrome --remote-debugging-port=9222 --user-data-dir=/tmp/chrome-debug
     ```
  4. **检查网络连通性**: 在虚拟机或容器环境中，确保主机和客户机之间的端口转发已正确配置。
- **预防措施**: 建立一个标准的启动和连接流程，并将其文档化。

**Section sources**
- [src/main.ts](file://src/main.ts#L50-L75)
- [src/browser.ts](file://src/browser.ts#L60-L126)
- [src/cli.ts](file://src/cli.ts#L20-L100)
- [README.md](file://README.md#L348-L482)
- [tests/browser.test.ts](file://tests/browser.test.ts#L47-L75)

## 权限与沙盒问题
权限和沙盒限制是导致 `chrome-devtools-mcp` 无法正常工作的深层原因。

### 操作系统沙盒限制
- **问题描述**: 某些 MCP 客户端（如在 macOS 上使用 Seatbelt 或在 Linux 上使用容器）会对 MCP 服务器进行沙盒化。这会阻止 `chrome-devtools-mcp` 启动需要创建自身沙盒的 Chrome 浏览器。
- **错误表现**: 服务器可能无法启动，或在尝试启动浏览器时静默失败。
- **解决方案**:
  1. **禁用 MCP 服务器的沙盒**: 在 MCP 客户端的设置中，为 `chrome-devtools-mcp` 禁用沙盒功能。
  2. **使用外部 Chrome 实例**: 放弃由 `chrome-devtools-mcp` 启动浏览器，改为手动在沙盒外部启动一个 Chrome 实例，并通过 `--browserUrl` 或 `--wsEndpoint` 进行连接。
- **预防措施**: 在部署前，检查 MCP 客户端的沙盒策略，并根据需要进行调整。

### 文件系统权限错误
- **问题描述**: 当工具（如 `take_screenshot`）尝试将文件写入指定路径时，可能因权限不足而失败。
- **错误信息**: `Could not save a screenshot to a file`
- **原因分析**: 指定的文件路径所在的目录对运行 `chrome-devtools-mcp` 的用户不可写。
- **解决方案**:
  1. **检查路径权限**: 确保目标目录存在且具有写权限。
  2. **使用临时目录**: 让工具使用默认的临时目录（由 `os.tmpdir()` 提供），该目录通常具有写权限。
  3. **以正确用户身份运行**: 确保运行 `chrome-devtools-mcp` 的用户拥有对目标路径的写权限。
- **预防措施**: 在脚本中使用 `try-catch` 块捕获此类错误，并提供清晰的错误消息。

**Section sources**
- [README.md](file://README.md#L468-L482)
- [src/McpContext.ts](file://src/McpContext.ts#L420-L450)
- [tests/tools/screenshot.test.ts](file://tests/tools/screenshot.test.ts#L169-L201)

## 性能瓶颈与超时
性能问题通常表现为操作超时或响应缓慢。

### 超时错误
- **错误信息**: `TimeoutError: Waiting for selector...`
- **原因分析**: `chrome-devtools-mcp` 内部为每个页面操作设置了默认超时（默认为 5000ms）。当网络条件差、CPU 被模拟限制或页面加载缓慢时，操作可能无法在超时前完成。
- **解决方案**:
  1. **利用内置的超时调整机制**: 当使用 `emulate_cpu` 或 `emulate_network` 工具时，`McpContext` 会自动根据模拟的 CPU 降速倍率和网络条件调整页面的默认超时时间，无需手动干预。
  2. **检查模拟设置**: 确认 `emulate_cpu` 和 `emulate_network` 的参数设置是否合理，避免设置过高的降速倍率。
- **预防措施**: 在进行性能分析时，理解超时机制是自动管理的，通常不需要额外配置。

### 性能分析无响应
- **问题描述**: 调用 `performance_start_trace` 后，长时间无响应或无法停止。
- **原因分析**: 浏览器页面可能处于一个非常复杂的加载状态，或者存在无限循环的 JavaScript。
- **解决方案**:
  1. **强制关闭页面**: 使用 `close_page` 工具关闭当前页面，这将终止正在进行的性能追踪。
  2. **重启 MCP 服务器**: 如果问题持续，重启整个 `chrome-devtools-mcp` 服务。
- **预防措施**: 在开始性能追踪前，确保目标页面处于稳定状态。

**Section sources**
- [src/McpContext.ts](file://src/McpContext.ts#L197-L220)
- [tests/McpContext.test.ts](file://tests/McpContext.test.ts#L45-L80)

## 工具调用失败
工具调用失败通常由参数错误或状态不一致引起。

### 关闭最后一个页面
- **错误信息**: `The last open page cannot be closed. It is fine to keep it open.`
- **原因分析**: 为了防止 MCP 服务器进入无页面可用的状态，`close_page` 工具禁止关闭最后一个打开的页面。
- **解决方案**: 无需解决，这是预期行为。可以安全地忽略此错误或在调用前检查页面数量。
- **预防措施**: 在调用 `close_page` 前，先使用 `list_pages` 工具确认至少有两个页面打开。

### 处理浏览器对话框
- **问题描述**: 当页面触发 `alert`, `confirm`, 或 `prompt` 对话框时，后续的页面操作会被阻塞。
- **错误表现**: 工具调用（如 `navigate_page`）会超时失败。
- **解决方案**:
  1. **使用 `handle_dialog` 工具**: 在对话框出现后，必须调用 `handle_dialog` 工具并传入 `accept` 或 `dismiss` 操作来处理它。
  2. **检查响应**: `McpResponse` 在格式化响应时会明确提示存在一个打开的对话框，并告知需要调用 `handle_dialog`。
- **预防措施**: 在自动化流程中，预见到可能弹出对话框的步骤，并在之后立即调用 `handle_dialog`。

### 快照过期
- **错误信息**: `This uid is coming from a stale snapshot. Call take_snapshot to get a fresh snapshot.`
- **原因分析**: `take_snapshot` 工具生成的快照是页面在某一时刻的静态表示。如果页面内容发生变化（如动态加载新元素），之前快照中的元素 ID (UID) 将失效。
- **解决方案**: 在页面发生重大变化后，重新调用 `take_snapshot` 工具以获取新的快照。
- **预防措施**: 将 `take_snapshot` 视为一个需要在关键操作前定期调用的“刷新”步骤。

**Section sources**
- [src/tools/ToolDefinition.ts](file://src/tools/ToolDefinition.ts#L120-L123)
- [src/McpContext.ts](file://src/McpContext.ts#L330-L350)
- [src/McpResponse.ts](file://src/McpResponse.ts#L279-L327)
- [src/tools/pages.ts](file://src/tools/pages.ts#L180-L232)

## 环境相关问题
在特殊环境中运行 `chrome-devtools-mcp` 需要额外的配置。

### 在 Docker 容器中运行
- **挑战**: 容器内通常没有图形界面（GUI），且可能缺少 Chrome 依赖库。
- **解决方案**:
  1. **使用 Headless 模式**: 在配置中添加 `--headless=true`。
  2. **安装依赖**: 在 Dockerfile 中安装必要的字体和共享库，例如 `libnss3`, `libatk-bridge2.0-0`, `libdrm-dev` 等。
  3. **传递 Chrome 参数**: 使用 `--chromeArg` 添加 `--no-sandbox`, `--disable-setuid-sandbox`, `--disable-dev-shm-usage` 等参数以适应容器环境。
  4. **设置视口**: 使用 `--viewport` 参数指定一个合适的初始视口大小。
- **示例配置**:
  ```json
  {
    "mcpServers": {
      "chrome-devtools": {
        "command": "npx",
        "args": [
          "chrome-devtools-mcp@latest",
          "--headless=true",
          "--chromeArg=--no-sandbox",
          "--chromeArg=--disable-dev-shm-usage",
          "--viewport=1280x720"
        ]
      }
    }
  }
  ```

### 在无 GUI 系统上运行
- **解决方案**: 与 Docker 环境类似，核心是使用 `--headless=true` 模式。确保系统已安装 Chrome 或 Chromium 浏览器。

**Section sources**
- [README.md](file://README.md#L283-L347)
- [package.json](file://package.json#L60-L65)

## 调试日志与诊断
启用详细的调试日志是诊断复杂问题的关键。

### 启用调试日志
- **方法**: 通过两种方式启用详细日志：
  1. **环境变量**: 设置 `DEBUG=*` 环境变量。例如，在启动命令前加上 `DEBUG=*`。
  2. **日志文件**: 使用 `--logFile /path/to/debug.log` 配置选项将日志输出到指定文件。
- **日志内容**: 日志会记录 MCP 服务器的启动、工具调用、浏览器连接状态以及内部错误。`mcp:log` 命名空间包含了核心日志。

### 解读常见错误码和异常
- **`DEBUG=mcp:*`**: 这是启用 `chrome-devtools-mcp` 特定日志的命名空间。当设置 `DEBUG=*` 时，它会被包含在内。
- **`Error: The browser is already running`**: 如前所述，表示用户数据目录被占用。
- **`Error: No page selected`**: 表示内部状态中的选中页面索引无效，通常发生在页面被外部关闭后。
- **`Error: No such element found in the snapshot`**: 表示尝试通过 UID 访问的元素在当前快照中不存在，需要重新生成快照。
- **诊断流程**:
  1. **重现问题**。
  2. **启用 `--logFile` 并设置 `DEBUG=*`**。
  3. **执行触发问题的操作**。
  4. **检查日志文件**，搜索错误信息和堆栈跟踪。
  5. **根据日志中的线索**，参考本指南的相应部分进行修复。

**Section sources**
- [src/main.ts](file://src/main.ts#L10-L15)
- [src/logger.ts](file://src/logger.ts#L1-L33)
- [README.md](file://README.md#L283-L347)